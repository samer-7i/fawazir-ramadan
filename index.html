<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Remy ğŸ® - Ø£Ø³Ø±Ø¹ Ø¥Ø¬Ø§Ø¨Ø©</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --bg: #0a1120; --card: #162136; --blue: #38bdf8; --text: #ffffff; --red: #e94560; }
        body { margin: 0; padding: 20px; background: var(--bg); color: var(--text); font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .setup-card { background: var(--card); padding: 30px; border-radius: 25px; border: 2px solid var(--blue); max-width: 400px; width: 85%; text-align: center; }
        input { width: 90%; padding: 15px; border-radius: 12px; border: 1px solid var(--blue); background: #0a1120; color: white; text-align: center; font-size: 1.1em; margin: 15px 0; outline: none; }
        .btn-action { background: var(--blue); color: var(--bg); border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; font-size: 1.1em; }
        .main-card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid rgba(56, 189, 248, 0.2); max-width: 500px; width: 100%; display: none; text-align: center; }
        .timer-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.1); margin-bottom: 20px; border-radius: 3px; overflow: hidden; }
        #timer-progress { width: 100%; height: 100%; background: var(--blue); transition: width 0.1s linear; }
        .user-info { display: flex; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 12px; margin-bottom: 15px; font-weight: bold; }
        .opt-btn { display: block; width: 100%; padding: 15px; margin: 10px 0; border: 1px solid var(--blue); background: rgba(56, 189, 248, 0.05); color: white; border-radius: 12px; cursor: pointer; font-size: 1.1em; font-weight: bold; }
    </style>
</head>
<body>

    <div id="setup-overlay" class="overlay">
        <div class="setup-card" id="rules-step">
            <h2 style="color: var(--blue);">ğŸ“œ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ø¯ÙŠ</h2>
            <p>Ø§Ù„Ù†Ù‚Ø·Ø© ØªØ°Ù‡Ø¨ ÙÙ‚Ø· Ù„Ù€ <b>Ø£ÙˆÙ„ Ø´Ø®Øµ</b> ÙŠØ¬Ø§ÙˆØ¨ ØµØ­!</p>
            <button class="btn-action" onclick="checkUserStatus()">ÙÙ‡Ù…ØªØŒ Ø§Ù„ØªØ§Ù„ÙŠ âœ…</button>
        </div>
        <div class="setup-card" id="name-step" style="display: none;">
            <h2>Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ ğŸ®</h2>
            <input type="text" id="username-input" placeholder="Ø§Ø³Ù…Ùƒ ÙÙŠ Ø¬Ø§ÙƒÙˆ...">
            <button class="btn-action" onclick="saveNewUser()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ğŸš€</button>
        </div>
    </div>

    <div id="waiting-msg" style="display:none; text-align:center;"><h3>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø¤Ø§Ù„... âŒ›</h3></div>

    <div id="quiz-container" class="main-card">
        <div class="timer-bar"><div id="timer-progress"></div></div>
        <div class="user-info">
            <span id="display-name"></span>
            <span style="color:var(--blue)">Ù†Ù‚Ø§Ø·ÙŠ: <span id="my-points">0</span> Ù†</span>
        </div>
        <div id="question-text" style="font-size: 1.4em; font-weight: bold; margin-bottom: 20px; color: var(--blue);"></div>
        <div id="options-container"></div>
        <div id="status-msg" style="margin-top: 15px; font-weight: bold;"></div>
    </div>

    <script>
        const config = { 
            apiKey: "AIzaSyBxqfLt3o3JWy_vwnpwSQPIVdtEDGoYB6k",
            authDomain: "fawazir-jaco.firebaseapp.com",
            databaseURL: "https://fawazir-jaco-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "fawazir-jaco",
            storageBucket: "fawazir-jaco.firebasestorage.app",
            messagingSenderId: "862747657100",
            appId: "1:862747657100:web:d52ecee9373a5e33fd8ca9"
        };
        firebase.initializeApp(config);
        const db = firebase.database();

        let userName = localStorage.getItem("remy_user_v3");
        let currentQIdx = -1;
        let timerInterval;

        function checkUserStatus() {
            if (userName) { document.getElementById("setup-overlay").style.display = "none"; startApp(); }
            else { document.getElementById("rules-step").style.display = "none"; document.getElementById("name-step").style.display = "block"; }
        }

        function saveNewUser() {
            const val = document.getElementById("username-input").value.trim();
            if (!val) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ!");
            userName = val; localStorage.setItem("remy_user_v3", userName);
            document.getElementById("setup-overlay").style.display = "none";
            startApp();
        }

        function startApp() {
            document.getElementById("display-name").innerText = userName;
            db.ref('totalPoints/' + userName).on('value', s => { document.getElementById("my-points").innerText = s.val() || 0; });
            db.ref('currentQuestion').on('value', snap => {
                const idx = snap.val();
                currentQIdx = idx;
                if (idx === -1 || idx === null) {
                    document.getElementById("quiz-container").style.display = "none";
                    document.getElementById("waiting-msg").style.display = "block";
                } else {
                    document.getElementById("waiting-msg").style.display = "none";
                    document.getElementById("quiz-container").style.display = "block";
                    showQuestion(idx);
                }
            });
        }

        function showQuestion(idx) {
            const myQuestions = [
                { q: "Ù…Ù† Ù‡Ùˆ Ø§Ù„Ù†Ø¨ÙŠ Ø§Ù„Ø°ÙŠ Ù„ÙÙ‚Ø¨ Ø¨ÙƒÙ„ÙŠÙ… Ø§Ù„Ù„Ù‡ØŸ", options: ["Ø¹ÙŠØ³Ù‰", "Ù…ÙˆØ³Ù‰", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…"], correct: 1 },
                { q: "Ù…Ø§ Ù‡ÙŠ Ø£Ø·ÙˆÙ„ Ø³ÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ØŸ", options: ["Ø§Ù„Ø¨Ù‚Ø±Ø©", "Ø§Ù„Ù†Ø³Ø§Ø¡", "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†"], correct: 0 }
            ];
            const data = myQuestions[idx];
            document.getElementById("question-text").innerText = data.q;
            const container = document.getElementById("options-container");
            container.innerHTML = ""; document.getElementById("status-msg").innerText = "";
            
            data.options.forEach((opt, i) => {
                const b = document.createElement("button");
                b.className = "opt-btn"; b.innerText = opt;
                b.onclick = () => submitAnswer(i, data.correct, idx);
                container.appendChild(b);
            });
            startTimer();
        }

        function startTimer() {
            clearInterval(timerInterval);
            let timeLeft = 15;
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                document.getElementById("timer-progress").style.width = (timeLeft / 15) * 100 + "%";
                if (timeLeft <= 0) { clearInterval(timerInterval); disableAll("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! â±ï¸"); }
            }, 100);
        }

        function submitAnswer(choice, correct, qIdx) {
            clearInterval(timerInterval);
            disableAll("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...");

            if (choice !== correct) {
                document.getElementById("status-msg").innerText = "Ø®Ø·Ø£ âŒ";
                return;
            }

            // Ù…Ù†Ø·Ù‚ "Ø£ÙˆÙ„ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·" Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Transaction
            const questionRef = db.ref('winners/' + qIdx);
            questionRef.transaction(currentData => {
                if (currentData === null) {
                    // Ù„Ù… ÙŠØ¬Ø§ÙˆØ¨ Ø£Ø­Ø¯ Ù‚Ø¨Ù„ÙƒØŒ Ø£Ù†Øª Ø§Ù„ÙØ§Ø¦Ø²!
                    return { name: userName, timestamp: firebase.database.ServerValue.TIMESTAMP };
                } else {
                    // Ø´Ø®Øµ Ø¢Ø®Ø± Ø³Ø¨Ù‚Ùƒ
                    return; // Ø¥Ø­Ø¨Ø§Ø· Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                }
            }, (error, committed, snapshot) => {
                if (committed) {
                    document.getElementById("status-msg").innerText = "ÙƒÙÙˆ! Ø£Ù†Øª Ø§Ù„Ø£ÙˆÙ„ ğŸ‰ +1 Ù†";
                    db.ref('totalPoints/' + userName).transaction(p => (p || 0) + 1);
                } else {
                    document.getElementById("status-msg").innerText = "ØµØ­ØŒ Ù„ÙƒÙ† Ù„Ù„Ø§Ø³Ù ØºÙŠØ±Ùƒ ÙƒØ§Ù† Ø£Ø³Ø±Ø¹ ğŸ’¨";
                }
            });
        }

        function disableAll(msg) {
            document.querySelectorAll(".opt-btn").forEach(b => b.disabled = true);
            if(msg) document.getElementById("status-msg").innerText = msg;
        }
    </script>
</body>
</html>
